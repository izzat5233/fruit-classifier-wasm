<script>
    let network;

    let structure = [2, 2];

    function updateNetworkDimensions(dimensions) {
        let vec = new Module.VecUInt();
        for (const number of dimensions) vec.push_back(number);
        network.setDimensions(vec);
    }

    Module.onRuntimeInitialized = () => {
        network = new Module.Network();
        network.setActivationFunction(document.getElementById('activationFunctionInput').value);
        network.setLossFunction(document.getElementById('lossFunctionInput').value);
        network.setLearningRate(document.getElementById('learningRateInput').value);
        updateNetworkDimensions(structure);
    }
</script>
<div class="container flex-column gap-4">
    <div class="row row-cols-1 row-cols-lg-3 g-4">
        <div class="col">
            <label for="inputLayerHeight" class="form-label">Input Layer Height</label>
            <input type="range" class="form-range" min="1" max="30" step="1" id="inputLayerHeight"
                   value="2" oninput="setStructureInput(Number(value))">
        </div>
        <div class="col">
            <label for="hiddenLayersCount" class="form-label">Hidden Layers Count</label>
            <input type="range" class="form-range" min="0" max="10" step="1" id="hiddenLayersCount"
                   value="1" oninput="updateStructureLength(Number(value) + 2)">
        </div>
        <div class="col">
            <label for="outputLayerHeight" class="form-label">Output Layer Height</label>
            <input type="range" class="form-range" min="1" max="30" step="1" id="outputLayerHeight"
                   value="2" oninput="setStructureOutput(Number(value))">
        </div>
    </div>
    <hr>
    <div id="hiddenLayersContainer"></div>
</div>
<script>
    function onStructureChange() {
        drawNetwork(structure);
        if (network) updateNetworkDimensions(structure);
        updateOutputFunctionLabel();
    }

    function setStructureInput(value) {
        structure[0] = value;
        document.getElementById('inputLayerHeight').value = value;
        onStructureChange();
    }

    function setStructureOutput(value) {
        structure[structure.length - 1] = value;
        document.getElementById('outputLayerHeight').value = value;
        onStructureChange();
    }

    function createHiddenLayerInput(index, value) {
        const input = document.createElement('input');
        input.type = 'range';
        input.min = '1';
        input.max = '30';
        input.value = value;
        input.index = index;
        input.className = 'form-range hidden-layer-input';
        input.id = 'hiddenLayerSizeInput' + index;
        input.oninput = () => {
            structure[Number(input.index) + 1] = Number(input.value);
            onStructureChange();
        }
        return input;
    }

    function updateStructureLength(desiredLength, defaultValue = 3) {
        const cont = document.getElementById('hiddenLayersContainer');
        const last = structure.pop()

        while (structure.length > desiredLength - 1) {
            structure.pop();
            cont.removeChild(cont.children[cont.children.length - 1]);
        }

        let index = structure.length - 1;
        while (structure.length < desiredLength - 1) {
            structure.push(defaultValue);
            cont.appendChild(createHiddenLayerInput(index, defaultValue));
            index++;
        }

        structure.push(last);
        onStructureChange();
    }

    function updateOutputFunctionLabel() {
        document.getElementById('outputFunctionInput').value = structure[structure.length - 1] === 1
            ? "Sigmoid (Single Output)"
            : "Softmax (Multiple Outputs)";
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateStructureLength(3);
        onStructureChange();
    });
</script>