<script>
    let network;

    let structure = [2, 2];

    function updateNetworkDimensions(dimensions) {
        let vec = new Module.VecUInt();
        for (const number of dimensions) vec.push_back(number);
        network.setDimensions(vec);
    }

    Module.onRuntimeInitialized = () => {
        network = new Module.Network();
        network.setActivationFunction(document.getElementById('activationFunctionInput').value);
        network.setLossFunction(document.getElementById('lossFunctionInput').value);
        network.setLearningRate(document.getElementById('learningRateInput').value);
        updateNetworkDimensions(structure);
    }
</script>
<div id="visualizerAccordion" class="accordion py-5">
    <div class="accordion-item" oninput="onStructureChange()">
        <h2 class="accordion-header">
            <button class="accordion-button lead fs-4" type="button" data-bs-toggle="collapse"
                    data-bs-target="#visualizerCollapseOne" aria-expanded="true" aria-controls="visualizerCollapseOne">
                Structure Controls
            </button>
        </h2>
        <div id="visualizerCollapseOne" class="accordion-collapse collapse show" data-bs-parent="#visualizerAccordion">
            <div class="accordion-body py-5">
                <div class="container flex-column gap-4">
                    <div class="row row-cols-1 row-cols-lg-3 g-4">
                        <div class="col">
                            <label for="inputLayerHeight" class="form-label">Input Layer Height</label>
                            <input type="range" class="form-range" min="1" max="10" step="1" id="inputLayerHeight"
                                   value="2" oninput="structure[0] = Number(value)">
                        </div>
                        <div class="col">
                            <label for="hiddenLayersCount" class="form-label">Hidden Layers Count</label>
                            <input type="range" class="form-range" min="0" max="10" step="1" id="hiddenLayersCount"
                                   value="1" oninput="updateStructureLength(Number(value) + 2)">
                        </div>
                        <div class="col">
                            <label for="outputLayerHeight" class="form-label">Output Layer Height</label>
                            <input type="range" class="form-range" min="1" max="10" step="1" id="outputLayerHeight"
                                   value="2" oninput="structure[structure.length - 1] = Number(value)">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="accordion-item" oninput="onStructureChange()">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed lead fs-4" type="button" data-bs-toggle="collapse"
                    data-bs-target="#visualizerCollapseTwo" aria-expanded="false" aria-controls="visualizerCollapseTwo">
                Hidden Layers Heights
            </button>
        </h2>
        <div id="visualizerCollapseTwo" class="accordion-collapse collapse" data-bs-parent="#visualizerAccordion">
            <div class="accordion-body py-5">
                <div id="hiddenLayersContainer"></div>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed lead fs-4" type="button" data-bs-toggle="collapse"
                    aria-expanded="false"
                    data-bs-target="#visualizerCollapseThree" aria-controls="visualizerCollapseThree">
                Advanced Controls
            </button>
        </h2>
        <div id="visualizerCollapseThree" class="accordion-collapse collapse" data-bs-parent="#visualizerAccordion">
            <div class="accordion-body row py-5 gy-5">
                <div class="col-sm-6">
                    <label for="learningRateInput" class="form-label">Learning Rate</label>
                    <input type="number" step="0.01" min="0.001" max="3" class="form-control" id="learningRateInput"
                           oninput="network.setLearningRate(value)" value="0.1">
                </div>
                <div class="col-sm-6">
                    <label for="activationFunctionInput" class="form-label">Activation Function</label>
                    <select class="form-select" id="activationFunctionInput"
                            onchange="network.setActivationFunction(value)">
                        <option value="relu">ReLU</option>
                        <option value="sigmoid">Sigmoid</option>
                        <option value="tanh">Tanh</option>
                    </select>
                </div>
                <div class="col-sm-6">
                    <label for="lossFunctionInput" class="form-label">Loss Function</label>
                    <select class="form-select" id="lossFunctionInput"
                            onchange="network.setLossFunction(value)">
                        <option value="sse">Sum Square Error</option>
                        <option value="mse">Mean Square Error</option>
                    </select>
                </div>
                <div class="col-sm-6">
                    <label for="outputFunctionInput" class="form-label">Output Function</label>
                    <input id="outputFunctionInput" class="form-control" type="text" aria-label="Disabled input example"
                           disabled readonly>
                </div>
                <div class="col-sm-6">
                    <label for="normalizationInput" class="form-label">Normalization</label>
                    <select class="form-select" id="normalizationInput">
                        <option value="minmax">Minmax [0, 1]</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="visualizer"></div>
<script src="js/visualizer.js"></script>
<script>
    function onStructureChange() {
        drawNetwork(structure);
        if (network) updateNetworkDimensions(structure);
        updateOutputFunctionLabel();
    }

    function createHiddenLayerInput(index, value) {
        const input = document.createElement('input');
        input.type = 'range';
        input.min = '1';
        input.max = '10';
        input.value = value;
        input.index = index;
        input.className = 'form-range hidden-layer-input';
        input.id = 'hiddenLayerSizeInput' + index;
        input.oninput = () => {
            structure[Number(input.index) + 1] = Number(input.value);
            onStructureChange();
        }
        return input;
    }

    function updateStructureLength(desiredLength, defaultValue = 3) {
        const cont = document.getElementById('hiddenLayersContainer');
        const last = structure.pop()

        while (structure.length > desiredLength - 1) {
            structure.pop();
            cont.removeChild(cont.children[cont.children.length - 1]);
        }

        let index = structure.length - 1;
        while (structure.length < desiredLength - 1) {
            structure.push(defaultValue);
            cont.appendChild(createHiddenLayerInput(index, defaultValue));
            index++;
        }

        structure.push(last);
    }

    function updateOutputFunctionLabel() {
        document.getElementById('outputFunctionInput').value = structure[structure.length - 1] === 1
            ? "Sigmoid (Single Output)"
            : "Softmax (Multiple Outputs)";
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateStructureLength(3);
        onStructureChange();
    });
</script>